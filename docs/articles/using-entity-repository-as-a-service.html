<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Why Doctrine's ServiceEntityRepository, and not EntityRepository, should be only be ever used as a service">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@_d1823">
    <meta property="og:url" content="https://1823.pl/articles/using-entity-repository-as-a-service">
    <meta property="og:title" content="Using Doctrine's EntityRepository as a service is a bad idea - d1823.pl">
    <meta property="og:description" content="Why Doctrine's ServiceEntityRepository, and not EntityRepository, should be only be ever used as a service">

    <base href="https://1823.pl/">

    <title>Using Doctrine's EntityRepository as a service is a bad idea - d1823.pl</title>

    <style>
        /*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */

/* Document
========================================================================== */

/**
 * 1. Correct the line height in all browsers.
 * 2. Prevent adjustments of font size after orientation changes in iOS.
 */

html {
  line-height: 1.15; /* 1 */
  -webkit-text-size-adjust: 100%; /* 2 */
}

/* Sections
========================================================================== */

/**
 * Remove the margin in all browsers.
 */

body {
  margin: 0;
}

/**
 * Render the `main` element consistently in IE.
 */

main {
  display: block;
}

/**
 * Correct the font size and margin on `h1` elements within `section` and
 * `article` contexts in Chrome, Firefox, and Safari.
 */

h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

/* Grouping content
========================================================================== */

/**
 * 1. Add the correct box sizing in Firefox.
 * 2. Show the overflow in Edge and IE.
 */

hr {
  box-sizing: content-box; /* 1 */
  height: 0; /* 1 */
  overflow: visible; /* 2 */
}

/**
 * 1. Correct the inheritance and scaling of font size in all browsers.
 * 2. Correct the odd `em` font sizing in all browsers.
 */

pre {
  font-family: monospace, monospace; /* 1 */
  font-size: 1em; /* 2 */
}

/* Text-level semantics
========================================================================== */

/**
 * Remove the gray background on active links in IE 10.
 */

a {
  background-color: transparent;
}

/**
 * 1. Remove the bottom border in Chrome 57-
 * 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari.
 */

abbr[title] {
  border-bottom: none; /* 1 */
  text-decoration: underline; /* 2 */
  text-decoration: underline dotted; /* 2 */
}

/**
 * Add the correct font weight in Chrome, Edge, and Safari.
 */

b,
strong {
  font-weight: bolder;
}

/**
 * 1. Correct the inheritance and scaling of font size in all browsers.
 * 2. Correct the odd `em` font sizing in all browsers.
 */

code,
kbd,
samp {
  font-family: monospace, monospace; /* 1 */
  font-size: 1em; /* 2 */
}

/**
 * Add the correct font size in all browsers.
 */

small {
  font-size: 80%;
}

/**
 * Prevent `sub` and `sup` elements from affecting the line height in
 * all browsers.
 */

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sub {
  bottom: -0.25em;
}

sup {
  top: -0.5em;
}

/* Embedded content
========================================================================== */

/**
 * Remove the border on images inside links in IE 10.
 */

img {
  border-style: none;
}

/* Forms
========================================================================== */

/**
 * 1. Change the font styles in all browsers.
 * 2. Remove the margin in Firefox and Safari.
 */

button,
input,
optgroup,
select,
textarea {
  font-family: inherit; /* 1 */
  font-size: 100%; /* 1 */
  line-height: 1.15; /* 1 */
  margin: 0; /* 2 */
}

/**
 * Show the overflow in IE.
 * 1. Show the overflow in Edge.
 */

button,
input { /* 1 */
  overflow: visible;
}

/**
 * Remove the inheritance of text transform in Edge, Firefox, and IE.
 * 1. Remove the inheritance of text transform in Firefox.
 */

button,
select { /* 1 */
  text-transform: none;
}

/**
 * Correct the inability to style clickable types in iOS and Safari.
 */

button,
[type="button"],
[type="reset"],
[type="submit"] {
  -webkit-appearance: button;
}

/**
 * Remove the inner border and padding in Firefox.
 */

button::-moz-focus-inner,
[type="button"]::-moz-focus-inner,
[type="reset"]::-moz-focus-inner,
[type="submit"]::-moz-focus-inner {
  border-style: none;
  padding: 0;
}

/**
 * Restore the focus styles unset by the previous rule.
 */

button:-moz-focusring,
[type="button"]:-moz-focusring,
[type="reset"]:-moz-focusring,
[type="submit"]:-moz-focusring {
  outline: 1px dotted ButtonText;
}

/**
 * Correct the padding in Firefox.
 */

fieldset {
  padding: 0.35em 0.75em 0.625em;
}

/**
 * 1. Correct the text wrapping in Edge and IE.
 * 2. Correct the color inheritance from `fieldset` elements in IE.
 * 3. Remove the padding so developers are not caught out when they zero out
 *    `fieldset` elements in all browsers.
 */

legend {
  box-sizing: border-box; /* 1 */
  color: inherit; /* 2 */
  display: table; /* 1 */
  max-width: 100%; /* 1 */
  padding: 0; /* 3 */
  white-space: normal; /* 1 */
}

/**
 * Add the correct vertical alignment in Chrome, Firefox, and Opera.
 */

progress {
  vertical-align: baseline;
}

/**
 * Remove the default vertical scrollbar in IE 10+.
 */

textarea {
  overflow: auto;
}

/**
 * 1. Add the correct box sizing in IE 10.
 * 2. Remove the padding in IE 10.
 */

[type="checkbox"],
[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}

/**
 * Correct the cursor style of increment and decrement buttons in Chrome.
 */

[type="number"]::-webkit-inner-spin-button,
[type="number"]::-webkit-outer-spin-button {
  height: auto;
}

/**
 * 1. Correct the odd appearance in Chrome and Safari.
 * 2. Correct the outline style in Safari.
 */

[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  outline-offset: -2px; /* 2 */
}

/**
 * Remove the inner padding in Chrome and Safari on macOS.
 */

[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}

/**
 * 1. Correct the inability to style clickable types in iOS and Safari.
 * 2. Change font properties to `inherit` in Safari.
 */

::-webkit-file-upload-button {
  -webkit-appearance: button; /* 1 */
  font: inherit; /* 2 */
}

/* Interactive
========================================================================== */

/*
 * Add the correct display in Edge, IE 10+, and Firefox.
 */

details {
  display: block;
}

/*
 * Add the correct display in all browsers.
 */

summary {
  display: list-item;
}

/* Misc
========================================================================== */

/**
 * Add the correct display in IE 10+.
 */

template {
  display: none;
}

/**
 * Add the correct display in IE 10.
 */

[hidden] {
  display: none;
}

:root {
  --color-background: #FEFEFE;
  --color-foreground: #222;
  --color-highlight: #F7BF05;
  --color-muted-background: #E5E5E5;
  --color-muted-foreground-1: #999;
  --color-muted-foreground-2: #777;
  --color-code-background: #F6F6F6;
  --color-code-border: #DDD;
}

html, body {
  font-family: Helvetica, Arial, sans-serif;
  color: var(--color-foreground);
  display: flex;
  justify-content: center;
  font-size: 14px;
}

body {
  width: 100%;
  box-sizing: border-box;
  padding: 1rem;
}

a {
  text-decoration-color: var(--color-highlight);
  text-decoration-thickness: 0.13em;
}

a:hover {
  text-decoration-line: none;
}

a:visited {
  color: var(--color-foreground);
}

.link--current {
  background: var(--color-highlight);
}

.link--current:hover {
  text-decoration-line: underline;
  text-decoration-color: var(--color-foreground);
}

body {
  background: var(--color-background);
  display: flex;
  align-items: center;
  flex-direction: column;
  margin: 1rem;
}

header {
  width: 100%;
  display: flex;
  gap: 1rem;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5rem;
}

header #logo {
  max-width: 10rem;
}

header nav {
  display: inline-flex;
  gap: 1rem;
}

#articles {
  width: 100%;
  line-height: 1.6em;
}

#articles .article-link {
  display: flex;
  align-content: center;
}

#articles .article-link:not(:first-of-type) {
  margin-top: 0.8em;
}

.article-link a {
  display: inline-block;
  background: var(--color-highlight);
  font-weight: bold;
  padding: 0 .2em;
  margin-right: .2em;
  text-decoration: none;
}

.article-link a:hover {
  text-decoration: underline;
  text-decoration-thickness: 0.1em;
}

.article-link .article-link__date {
  background: var(--color-muted-background);
  color: var(--color-muted-foreground-1);
  font-size: .8em;
  margin-right: .4em;
  padding: 0 .2em;
}

.page {
  width: 100%;
}

.page__header {
  display: inline;
  font-size: 1.6rem;
  line-height: 1.6em;
}

.page__content {
  line-height: 1.8rem;
  font-size: 1.1rem
}

.page__content figure {
  background: var(--color-code-background);
  padding: 1em;
  margin: 2em 0;
  border: 2px dashed var(--color-code-border);
  text-align: center;
}

.page__content figure figcaption {
  padding: .5em;
  font-size: .8em;
}

.page__content figure img {
  max-width: 100%;
}

.page__content > pre,
.page__content > .sourceCode {
  background: var(--color-code-background);
  padding: 1em;
  border: 2px dashed var(--color-code-border);
  word-break: break-all;
  word-wrap: break-word;
  margin: 2em 0;
}

.page__content > .sourceCode pre {
  margin: 0;
}

.page__content pre code {
  padding: 0;
  font-size: .9em;
  color: inherit;
  white-space: pre-wrap;
  background-color: transparent;
  border-radius: 0;
  line-height: 1.4rem;
}

.page__content p > code {
  background: var(--color-code-background);
  border: 1px dashed var(--color-code-border);
  padding: 0 .5em;
  white-space: nowrap;
}

.header__title  {
  background: var(--color-highlight);
  display: inline-block;
  font-size: 1em;
  font-weight: bold;
  padding: 0 .2em;
}

.header__meta  {
  color: var(--color-muted-foreground-1);
  font-size: .6em;
}

.header__meta a {
  color: var(--color-muted-foreground-2);
}

footer {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  margin: 4rem;
  font-size: .8rem;
}

@media screen and (min-width: 1280px) {
  html, body {
    font-size: 16px;
  }

  body {
    width: 1024px;
  }


  .page__content > pre,
  .page__content > .sourceCode,
  .page__content figure {
    margin-left: -1.5em;
    margin-right: -1.5em;
  }

  header nav {
    font-size: 1.1rem;
    gap: 3rem;
  }

  header #logo {
    width: unset;
  }

  #articles {
    font-size: 1.4rem;
  }
}
a.sourceLine {
  display: inline-block;
  line-height: 1.25;
}

a.sourceLine {
  pointer-events: none;
  color: inherit;
  text-decoration: inherit;
}

a.sourceLine:empty {
  height: 1.2em;
}

@media print {
  a.sourceLine {
    text-indent: -1em;
    padding-left: 1em;
  }
}

pre.numberSource a.sourceLine {
  position: relative;
  left: -4em;
}

pre.numberSource a.sourceLine::before {
  content: attr(title);
  position: relative;
  left: -1em;
  text-align: right;
  vertical-align: baseline;
  border: none;
  pointer-events: all;
  display: inline-block;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  padding: 0 4px;
  width: 4em;
}

pre.numberSource {
  margin-left: 3em;
  padding-left: 4px;
}

div.sourceCode {}

@media screen {
  a.sourceLine::before {
    text-decoration: underline;
  }
}

/* Alert */
code span.al {
  font-weight: bold;
}

/* Annotation */
code span.an {
  font-style: italic;
}

/* ControlFlow */
code span.cf {
  font-weight: bold;
}

/* Comment */
code span.co {
  font-style: italic;
}

/* CommentVar */
code span.cv {
  font-style: italic;
}

/* Documentation */
code span.do {
  font-style: italic;
}

/* DataType */
code span.dt {
  text-decoration: underline;
}

/* Error */
code span.er {
  font-weight: bold;
}

/* Information */
code span.in {
  font-style: italic;
}

/* Keyword */
code span.kw {
  font-weight: bold;
}

/* Preprocessor */
code span.pp {
  font-weight: bold;
}

/* Warning */
code span.wa {
  font-style: italic;
}
    </style>

    <link
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQzuoCGaoThZERRy1CkWoEGqFVh1MLv2CJg1Jiouj4Fpw8GOx6uDirKuDqyAIfoC4ujgpukiJ/0sKLWI8OO7Hu3uPu3eAUC8zzeoYBzTdNlOJuJjJropdrwhiAGEMIyQzy5iTpCR8x9c9Any9i/Es/3N/jl41ZzEgIBLPMsO0iTeIpzdtg/M+cYQVZZX4nHjMpAsSP3Jd8fiNc8FlgWdGzHRqnjhCLBbaWGljVjQ14iniqKrplC9kPFY5b3HWylXWvCd/YSinryxzneYQEljEEiSIUFBFCWXYiNGqk2IhRftxH/+g65fIpZCrBEaOBVSgQXb94H/wu1srPznhJYXiQOeL43yMAF27QKPmON/HjtM4AYLPwJXe8lfqwMwn6bWWFj0C+raBi+uWpuwBlztA/5Mhm7IrBWkK+TzwfkbflAXCt0DPmtdbcx+nD0CaukreAAeHwGiBstd93t3d3tu/Z5r9/QBS3nKamEF+kgAAAAZiS0dEAP0AcAA7rB2u5wAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+cDGRUMGX8XZQgAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAC/0lEQVR42u3by2sTQRwH8O/MbJPYpm9bU6qJEm1BPbSCgiDqTWxFvGrFQ/8AsQcv/gFa8KQHqYgHwYuIePAgilI8ScG2qPVRsI0varQNTdMkbZKdGQ8VtbabrM86ye93HTbZ+ex35wXL5vrLNEq4OEq8CIAACIAACIAACIAACIAACKA0y/rvbmjLIMTqrcu2ZQd7oJMXKAEEQAAEQAAEQADFCqBliQPITJGtBEU7ROA4eN02sIomMKscYAw6l4LOxKFiQ1DRK9DZ218CMF88AGLNeYhwF1iZf0kb81aDeavBq0JAsBP2+HXIiW6wXLw4AKz1NyBCB1xKeWBt6gJWNUPNvoQwHUAE+tx3/vubWbsXMlpu9iDIPJ2wwod/A2+H2a8AD/UAlq/AVKeh0x+hs7OA8IBXBADhLYLzAL4ZVuP2/LPcpyHIsdPQ2VuLrwv1QgT3mQ3A67vzPn0ZHYA9untpg3oOO3IQWtyF1bzH3DGA1bQ5pz6Xhv3qZP50RE4BMmsuAPcHnTs3OQzIgQKrwEeQsWcGJ8BX55yA6UF3W4FkxFAAVr/siu9rx1LD7gDSY4YC8I0AY84dy7hLAHLTZgIwXpXnsSpAjbpLgG0ogLZH8ukA8Bf5gYj+kH8Ks9rcJcmqMXcW0Pac8x+V73T3I76QwQAZ5/eXVbe7S0Blq7kAasZ5CuMNLnZ5rAmiod3gBCScB0JeuQ4i0FfgEOUimNfgMUDFbwLKdu5gyzGI4DWA/xBzaxdE+I75u0HYDyGnnkI0OsSYCVgbDsEKdkClooCcB8oqFs4DmMBK1B8/EZJvLhU+2xce8KogeG0LuL95xTr/VwB0+jLku3u/dm0uBTn5xGwAALAjRyAnH/9kdHKwR85ARs4B0GYDAEnYL/ZDvr+/sA8oNHgm3iI7fAIqcRZ67ipUfNzQQXBRnmOwxzogJ46CN3WB17aC+erBhAdaZoDsLFTiNdTUA6hYL4DkN5BoP3hN+J8AMPpkpsSLAAiAAAiAAAiAAAiAAAigROszfw/sXyvnr2MAAAAASUVORK5CYII="
        rel="icon" type="image/x-icon">
    <link rel="alternate" type="application/rss+xml" href="feed.xml" title="Using Doctrine's EntityRepository as a service is a bad idea - d1823.pl">
</head>
<body>

<header>
    <a href="/">
        <img id="logo"
             src="data:image/webp;base64,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"
             alt="d1823.pl logo">
    </a>

    <nav>
        <a href="/" class="link--current">Articles</a>
        <a href="/projects" >Projects</a>
        <a href="/about" >About</a>
    </nav>
</header>

<section class="page">
    <div class="page__header">
        <div class="header__meta">from 20/01/2023</div>        <h1 class="header__title">Using Doctrine's EntityRepository as a service is a bad idea</h1>
    </div>

    <div class="page__content">
        
<p>If you&#x2019;re using Symfony, you&#x2019;ve definitely written a Doctrine
repository at some point. If you&#x2019;ve been using Symfony long enough,
you&#x2019;ve probably seen the introduction of
<em>ServiceEntityRepository</em> that complemented the default
<em>EntityRepository</em> base class. Its initial goal was to ease the
use of repositories with service containers, instead of being tied
directly to Doctrine, but that&#x2019;s not what I want to talk about. I really
want to talk about the implications of using the
<em>EntityRepository</em> in a project, where every other repository
extends the <em>ServiceEntityRepository</em>.</p>
<p>During a bug-fixing-technical-debt-reducing period in one of the
projects I&#x2019;m working on, I decided to take a look at a long-standing
issue that was popping up in logs from time to time. It wasn&#x2019;t anything
critical as the crash was happening in the context of Symfony&#x2019;s message
consumer in the Messenger component, but the handler run often enough to
eventually do what it was supposed to do. The exception we&#x2019;ve been
getting was &#x201C;Entity manager is closed&#x201D; thrown by Doctrine. It wasn&#x2019;t
apparent why it was thrown in the first place, because none of the
operations executed by Doctrine, before this exception, failed in any
way.</p>
<p>I&#x2019;ve spent hours verifying the database schema and various input sets
while trying to reproduce the crash locally. Eventually, I decided to
look at it in a broader context - the handler was executed by a
long-running consumer. It became apparent that the reason for throwing
that exception might&#x2019;ve originated from a different part of the code
that wasn&#x2019;t part of the executions paths under the affected handler. I
looked at logs preceding the crash and noticed a pattern where it would
only throw an exception if a previously consumed message resulted in the
Doctrine exception as well.</p>
<p>I was on the right track. At this point, I knew that the entity
manager was being closed because of an exception thrown by a different
handler processing a previous message. One question remained - why
wasn&#x2019;t Doctrine reset to its original state before consuming a new
message? After all, Messenger handles it implicitly through the <a href="https://github.com/symfony/doctrine-bridge/blob/5.4/Messenger/DoctrinePingConnectionMiddleware.php"><em>DoctrinePingConnectionMiddleware</em></a>
- it resets the manager before passing the execution to the rest of the
middleware stack.</p>
<p>Here&#x2019;s where the topic of this article comes to light. It&#x2019;s because
of the difference between the constructors of <em>EntityRepository</em>
and <em>ServiceEntityRepository</em>. Let&#x2019;s take a look at both of
these:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="cn">E</span>ntityRepository <span class="kw">implements</span> <span class="cn">O</span>bjectRepository<span class="ot">,</span> <span class="cn">S</span>electable</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">function</span> <span class="bu">__construct</span>(<span class="cn">E</span>ntityManagerInterface <span class="va">$em</span><span class="ot">,</span> <span class="cn">C</span>lassMetadata <span class="va">$class</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">$this</span>-&gt;<span class="cn">_</span>entityName <span class="op">=</span> <span class="va">$class</span>-&gt;name<span class="ot">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">$this</span>-&gt;<span class="cn">_</span>em         <span class="op">=</span> <span class="va">$em</span><span class="ot">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">$this</span>-&gt;<span class="cn">_</span>class      <span class="op">=</span> <span class="va">$class</span><span class="ot">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="cn">S</span>erviceEntityRepository <span class="kw">extends</span> <span class="cn">E</span>ntityRepository <span class="kw">implements</span> <span class="cn">S</span>erviceEntityRepositoryInterface</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">function</span> <span class="bu">__construct</span>(<span class="cn">M</span>anagerRegistry <span class="va">$registry</span><span class="ot">,</span> <span class="dt">string</span> <span class="va">$entityClass</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">$manager</span> <span class="op">=</span> <span class="va">$registry</span>-&gt;getManagerForClass(<span class="va">$entityClass</span>)<span class="ot">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="va">$manager</span> <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">LogicException</span>(<span class="fu">sprintf</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Could not find the entity manager for class "%s". Check your Doctrine configuration to make sure it is configured to load this entity&#x2019;s metadata.'</span><span class="ot">,</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                <span class="va">$entityClass</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>            ))<span class="ot">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">parent</span>::<span class="bu">__construct</span>(<span class="va">$manager</span><span class="ot">,</span> <span class="va">$manager</span>-&gt;getClassMetadata(<span class="va">$entityClass</span>))<span class="ot">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We can immediately notice two things - first, the
<em>ServiceEntityRepository</em> is extending the
<em>EntityRepository</em>; second, in contrast to its parent,
<em>ServiceEntityRepository</em> isn&#x2019;t constructed with an object
implementing the <em>EntityManagerInterface</em>, but with an instance
of <em>ManagerRegistry</em> instead. What&#x2019;s the difference?</p>
<p>When an <em>EntityManager</em> encounters a driver exception during
the <em>flush</em> operation, it&#x2019;s going to close. You won&#x2019;t be able to
use this instance anymore as there&#x2019;s no way to make it reopen. By
extension, all instances of repositories using that exact instance of
<em>EntityManager</em> will become useless. You can, of course, reach
the <em>ManagerRegistry</em> and call the <em>resetManager</em> method,
but that won&#x2019;t fix anything, aside from giving you a fresh instance
<em>EntityManager</em>. With <em>ServiceEntityRepository</em> it&#x2019;s a
different story. Symfony implements its own <em>ManagerRegistry</em>
that knows how to talk to a PSR&#x2019;s <em>ContainerInterface</em> and the
<em>EntityManager</em> returned by the
<em>ManagerRegistry::getManagerForClass</em> method is a proxy! When
such <em>ManagerRegistry</em> is asked for a fresh
<em>EntityManager</em>, it doesn&#x2019;t only construct a new one, it updates
that same proxy with a fresh, connected instance. That way, when you
reset the manager as part of your exception-handling procedure, this
change is propagated throughout the system.</p>
<p>With all that, let&#x2019;s come back to my original issue. At this point,
we understand that the <em>EntityManager</em> should&#x2019;ve been reset
before handling a new message, but it wasn&#x2019;t. When I took a look at the
affected repository one more time, I noticed the issue. It was extending
the <em>EntityRepository</em>, not the <em>ServiceEntityRepository</em>!
When the messenger&#x2019;s middleware reset the manager, that repository
wasn&#x2019;t affected by that change! The first <em>flush</em> operation had
to fail because it was using an obsolete entity manager.</p>
<p>At this point, you might be a little confused. Didn&#x2019;t I just say that
<em>ServiceEntityRepository</em> constructs itself with a proxy to
<em>EntityManager</em>? How am I sure it&#x2019;s not the same with Doctrine&#x2019;s
<em>EntityManager</em>? It&#x2019;s because of its service definition and how
it&#x2019;s fetched from the service container. If you take a look at the <a href="https://github.com/doctrine/DoctrineBundle/blob/2.8.x/DependencyInjection/DoctrineExtension.php"><em>DependencyInjection\DoctrineExtension</em></a>,
you&#x2019;ll notice that every configured entity manager is a service.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode php"><code class="sourceCode php"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">$container</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    -&gt;setDefinition(<span class="va">$entityManagerId</span><span class="ot">,</span> <span class="kw">new</span> <span class="cn">C</span>hildDefinition(<span class="st">'doctrine.orm.entity_manager.abstract'</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    -&gt;setPublic(<span class="kw">true</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    -&gt;setArguments([</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="cn">R</span>eference(<span class="fu">sprintf</span>(<span class="st">'doctrine.dbal.%s_connection'</span><span class="ot">,</span> <span class="va">$entityManager</span>[<span class="st">'connection'</span>]))<span class="ot">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="cn">R</span>eference(<span class="fu">sprintf</span>(<span class="st">'doctrine.orm.%s_configuration'</span><span class="ot">,</span> <span class="va">$entityManager</span>[<span class="st">'name'</span>]))<span class="ot">,</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    -&gt;setConfigurator([<span class="kw">new</span> <span class="cn">R</span>eference(<span class="va">$managerConfiguratorName</span>)<span class="ot">,</span> <span class="st">'configure'</span>])<span class="ot">;</span></span></code></pre></div>
<p>Additionally, since the <em>EntityManagerInterface</em> is an alias
to the <em>default_entity_manager</em>, you can be sure that when
injected directly, it won&#x2019;t be a proxy.</p>
<pre><code>Information for Service "doctrine.orm.default_entity_manager"
=============================================================

 The EntityManager is the central access point to ORM functionality.

 ---------------- ---------------------------------------------------------- 
  Option           Value                                                     
 ---------------- ---------------------------------------------------------- 
  Service ID       doctrine.orm.default_entity_manager                       
  Class            Doctrine\ORM\EntityManager                                
  Tags             container.preload (class: Doctrine\ORM\Proxy\Autoloader)  
  Public           yes                                                       
  Synthetic        no                                                        
  Lazy             yes                                                       
  Shared           yes                                                       
  Abstract         no                                                        
  Autowired        no                                                        
  Autoconfigured   no                                                        
  Factory Class    Doctrine\ORM\EntityManager                                
  Factory Method   create                                                    
 ---------------- ----------------------------------------------------------</code></pre>
<p>My takeaway from this case is to never use the
<em>EntityManagerInterface</em> as a direct dependency. I even went as
far as writing a PHPStan extension that forbids it. There are no
legitimate cases that I can&#x2019;t think of that would require it, and the
bugs caused by incorrect usage are really hard to track. I can&#x2019;t tell
you what to do, but as for me - I&#x2019;m adding this thing to my list of
&#x201C;must-do&#x201D; things while working on Symfony codebases.</p>

    </div>
</section>

<footer>
    Copyright &copy; 2020-2023 1823.pl&nbsp;&mdash;&nbsp;<a
        href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>
</footer>

</body>
</html>
